# 作科所生物信息集群使用说明

## 本集群使用Sun Grid Engine (SGE)作业调度系统

集群配置了五个队列以满足不同类型的计算需求，每个队列具体的cpu核心数及内存大小为：

| queue | host | nodes | cpu | memory | walltime |
| ----- | ---- | ----  | ----| ----   | ----     |
| all.q | compute-0-1 : compute-0-13 | 13 | 24/48 | 188G | 
| all.q | v2-01 : v2-04	| 4 | 20 | 125G | 
| gpu.q | gpu1 : gpu9 | 9 | 24/48 | 126G | 
| smallfat.q | compute-20 : compute-28 | 9 | 60 | 252G | 
| m610.q | m610-1 : m610-15 | 15 | 24 | 31G | 
| fatnode.q | fatnode4t_lower | 1 | 96 | 3.9T | 

用户可根据任务所需的计算资源（cpu核心数，内存大小）选择合适的队列。

注意：

1. **登录节点/头结点只能进行程序安装和调试、数据传输、文档整理等小任务，禁止直接运行诸如blast、bwa等繁重任务。**目前登录节点已开启用户进程监控，凡使用超过10G内存，3个线程超过20分钟以上的用户进程都会被系统自动结束，以保证其他登录用户的基本操作。

2. **本集群必须使用 `-l h_mem=xG` 指定任务所需内存大小**，如 `-l h_mem=15G` 即申请一个最多使用15G内存的任务。

## 任务提交

使用qsub命令提交任务，既可以在命令行下直接通过qsub的附带参数进行提交，也可以通过创建任务脚本的方式提交任务。我们推荐使用后一种（创建任务脚本）方式提交任务。

以下为一个典型的任务脚本(job.sh)，可以点击右侧按钮复制代码或[这里下载原始脚本](job.sh)。

```
#!/bin/bash -l
#$ -N test
#$ -cwd
#$ -S /bin/bash
#$ -V
#$ -q all.q
#$ -l h_vmem=20G
#$ -l s_rt=10:00:00
#$ -pe smp 4
#$ -m a
#$ -M myemail@caas.cn
#$ -j y
#$ -o job.out

blastall -p blastn -i test.fa -d wheat.db -o abc.out
```

说明：
- `#!/bin/bash`: 环境变量
- `-N test`: 设定任务名（qstat查询时的任务名称）为test
- `-cwd`: 在当前路径下投递，SGE日志会输出到当前目录
- `-S /bin/bash`: 指明命令解释器:SGE默认使用的是tcsh,而要投放的.sh是bash
- `-V`: 导出用户在提交节点的环境变量到计算节点，最好加上，否则计算节点可能找不到用户自己安装的程序
- `-q all.q`: 指定投递队列（all.q)
- `-l resource=value`: 表明作业运行所需要的资源
  - `-l h_vmem=20G`: 指定此任务最大内存为 20G，实际使用内存如果超过 20G，此任务将会被作业
调度系统结束
  - `-l s_rt=10:00:00`: 指定任务执行大约需要10小时，只是大概估计，超过10小时任务不会被结束
- `-pe smp 4`: 指定任务执行需要4个线程/CPU核心，已进行并发计算，默认为单线程（1）
- `-j y`: 将标准输出与标准错误信息合并到一个文件中
- `-o job.out`：定义或重定义作业标准输出流
- `-M myemail@caas.cn`：定义邮件地址, 任务出错时会发送邮件到该邮箱地址
- `-m b|e|a|s|n`: 定义邮件发送规则 - b：作业开始时发送; e：作业结束时发送; a：作业失败时发送; s：作业挂起时发送; n：不发送
- `-o job.out`：定义或重定义作业标准输出流

## 任务内存估计

本集群必须使用 `-l h_mem=xG` 指定任务的可使用最大内存。 该参数默认值为4GB，也就是说如果不设定该参数，则任务使用内存超过 4GB时将被杀死。

如果估计任务运行所需的内存？可以首先提交一个典型任务，运行成功后 通过 `qcct` 命令查询   jobid，再通过 `qacct -j jobid` 查看任务详细资源使用情况，然后再设定 `h_vmem` 参数。

## 交互式任务执行

当希望运行 R 等交互式任务时，可通过 `qlogin -l h_vmem=xG` 获取计算节点，如：`qlogin  -l h_vmem=10G，hostname=fatnode4T` ，此命令含义为向对列 `all.q` 申请一个在节点 `fatnode4T`上运行的shell 环境。 当资源紧张时执行qlogin 获取计算节点不成功时，可以设定较小的h_vmem 值获取。
    

## 任务查看与管理

- `qstat`    查看当前用户提交的所有作业  
- `qstat -j 11135` 查看用户jobid 为 11135 的任务运行信息
- `qstat -f` 查看所有提交任务的详细信息   
- `qhost -j` 查看集群各节点运行任务情况
- `qdel -j 11135` 删除jobid 11135的任务
- `qdel -u zhangl`    删除用户 zhangl的所有任务

  